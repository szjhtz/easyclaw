name: Build & Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm

      - name: Setup OpenClaw vendor
        run: |
          git clone https://github.com/openclaw/openclaw.git vendor/openclaw
          cd vendor/openclaw
          git checkout e78ae48e6
          pnpm install --frozen-lockfile
          pnpm run build

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build packages
        run: pnpm run build

      - name: Build Windows app
        run: |
          cd apps/desktop
          pnpm run dist:win
        env:
          # Code signing will be handled by SignPath
          CSC_IDENTITY_AUTO_DISCOVERY: false

      - name: Upload unsigned installer for signing
        uses: actions/upload-artifact@v4
        with:
          name: unsigned-windows-installer
          path: apps/desktop/release/*.exe
          retention-days: 7

      # TODO: Once SignPath is configured, add signing step here
      # - name: Submit to SignPath for signing
      #   uses: signpath/github-action-submit-signing-request@v1
      #   with:
      #     api-token: ${{ secrets.SIGNPATH_API_TOKEN }}
      #     organization-id: ${{ secrets.SIGNPATH_ORGANIZATION_ID }}
      #     project-slug: 'easyclaw'
      #     signing-policy-slug: 'release-signing'
      #     artifact-configuration-slug: 'windows-installer'
      #     input-artifact-path: 'apps/desktop/release/EasyClaw-Setup.exe'
      #     output-artifact-path: 'apps/desktop/release/EasyClaw-Setup-Signed.exe'

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-installers
          path: |
            apps/desktop/release/*.exe
            apps/desktop/release/*.exe.blockmap
          retention-days: 30

  build-macos:
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm

      - name: Setup OpenClaw vendor
        run: |
          git clone https://github.com/openclaw/openclaw.git vendor/openclaw
          cd vendor/openclaw
          git checkout e78ae48e6
          pnpm install --frozen-lockfile
          pnpm run build

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build packages
        run: pnpm run build

      # Import code signing certificate (when secrets are configured)
      - name: Import Code Signing Certificate
        if: ${{ env.MACOS_CERTIFICATE != '' }}
        env:
          MACOS_CERTIFICATE: ${{ secrets.MACOS_CERTIFICATE }}
          MACOS_CERTIFICATE_PWD: ${{ secrets.MACOS_CERTIFICATE_PWD }}
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
        run: |
          echo "$MACOS_CERTIFICATE" | base64 --decode > certificate.p12
          security create-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
          security import certificate.p12 -k build.keychain -P "$MACOS_CERTIFICATE_PWD" -T /usr/bin/codesign
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" build.keychain

      - name: Build macOS app
        run: |
          cd apps/desktop
          pnpm run dist:mac
        env:
          # Notarization credentials (optional, only if configured)
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-installers
          path: |
            apps/desktop/release/*.dmg
            apps/desktop/release/*.zip
          retention-days: 30

  create-release:
    needs: [build-windows, build-macos]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
    steps:
      - name: Download Windows artifacts
        uses: actions/download-artifact@v4
        with:
          name: windows-installers
          path: ./release/windows

      - name: Download macOS artifacts
        uses: actions/download-artifact@v4
        with:
          name: macos-installers
          path: ./release/macos

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          draft: true
          generate_release_notes: true
          files: |
            release/windows/*.exe
            release/macos/*.dmg
            release/macos/*.zip
